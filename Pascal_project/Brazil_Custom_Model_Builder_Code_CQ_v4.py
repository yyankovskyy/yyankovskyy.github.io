
#'#*****************************************************************************************************************************************************
''# Project name  				: Intelligent Classifier
''# File Name   				: Updated_Python_Code_template.py 
''# Date of Updation    		: 09 Nov 2019
''# Purpose       				: Python Code Template for Upload into Intelligent Classifier Solution
''# Created By      			: Eugene Yankovsky
#'#***************************************************************************************************************************************************** 

#SPECIFY PACKAGES USED:
#---------------------#

#@packages used
import pandas as pd
import nltk
import numpy as np
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import SGDClassifier
from sklearn import metrics
import pickle
import os
from unidecode import unidecode

#from sklearn.ensemble import RandomForestClassifier
#import time
#import re

#Download two packages for text mining in Portuguese
#nltk.download('stopwords')
#nltk.download('rslp')

#---------------------------------------------------------------#
  

#Training_Data = pd.read_pickle('C:\\Users\\Desktop\\Foundry\\Sample Data\\input_dataframe.pkl')
 
#PRE-PROCESSING STEP



#PRE-PROCESSING STEP
#'#****************************************************************************************************************************************************
''# Description  					: Code to perform the cleansing & transformation steps on the data before model training & prediction
''# Steps Followed					: Includes Stemming,Lemmatization, stop words removal, entity  normalization, engineered features,vectorisation
''# Input Parameters      			: Input dataframe   $consolidated data for model training as dataframe
''# Output Parameters   			: Processed dataframe,Target_class / label,Vectorized Data, Function execution success flag,Function execution Status Description
''# Author     						: Eugene Yankovsky
#'#****************************************************************************************************************************************************


#Define Pre-processing function below:
#-------------------------------------#

def pre_processing(input_dataframe, Training_Data):
    
    target_class =""
    processed_dataframe = ""
    vectorized_data = ''  
    Required_Columns = ['TARIFF CODE', 'PRODUCT DESCRIPTION']
    Missing_Columns=[item for item in Required_Columns if item not in input_dataframe.columns]
    if len(Missing_Columns)>0:
        Status_desc = "Missing required column(s) : "+",".join(Missing_Columns)
        success_flag = 'no'
        return(processed_dataframe,target_class,vectorized_data,success_flag, Status_desc)
        raise Exception('Missing Column error!')
    try: 	
         
        stopwords = nltk.corpus.stopwords.words('portuguese')
        stopwords_noaccent = [unidecode(w) for w in stopwords]
        
        def data_cleaning(df):
            PD = df['PRODUCT DESCRIPTION'].astype('str')
            PD = df['PRODUCT DESCRIPTION'].str.lower() # change everything to lowercase
            PD = PD.astype('str')
            PD = PD.apply(unidecode)
            PD = PD.str.replace('\'', '', case=False)
            PD = PD.str.replace('[^A-Za-z0-9\s]+', ' ', case=False) #remove special characters
            PD = PD.str.replace('\d+\.?\d*', '', case=False) # remove numbers          
            PD = PD.str.replace(r'\b\w{1}\b', '', case=False) # remove words with only one character
            PD = PD.str.split() # split descriptions into words
            PD = PD.apply(lambda x: [w for w in x if not w in stopwords_noaccent]) # remove stopwords
            PDclean = PD.apply(lambda x: " ".join(x)).tolist()
            return PDclean
    
        tfidf_vectorizer = TfidfVectorizer(min_df=1, 
                                     norm='l2', 
                                     max_features=300000, 
                                     smooth_idf=True, 
                                     use_idf=True, 
                                     ngram_range=(1,2))

        corpus = Training_Data['PRODUCT DESCRIPTION'].copy().astype('str')
        vectorizer_fit = tfidf_vectorizer.fit(corpus)
        input_dataframe['CLEANED PRODUCT DESCRIPTION'] = data_cleaning(input_dataframe)
        vectorized_data= vectorizer_fit.transform(input_dataframe['CLEANED PRODUCT DESCRIPTION'])        
        processed_dataframe=input_dataframe
        target_class = processed_dataframe['TARIFF CODE'].copy().astype('str')
        success_flag = 'yes'
        Status_desc = 'Preprocessing Successfully Completed'	        
        
    except Exception as error_desc:         
        Status_desc = error_desc
        success_flag = 'no'
        tfidf_vectorizer = ''
        
    return(processed_dataframe, target_class, vectorized_data, success_flag, Status_desc)

#---------------------------------------------------------------------#

# MODEL TRAINING:

# MODEL TRAINING:

#'#****************************************************************************************************************************************************
''# Description  					: Code to perform model training process
''# Steps Followed					: Includes model algorithm execution & model file creation
''# Input Parameters      			: Target_class / label, Vectorized Data from Pre-processing
''# Outputs Parameters   			: Model File Object will be returned,Function execution success flag,Function execution Status Description
''# Author     						: Eugene Yankovsky
#'#****************************************************************************************************************************************************

#Define Model Training function below:
#-------------------------------------#	

def model_train(target_class, vectorized_data):

    try:
        model = SGDClassifier(loss='hinge', alpha=0.0000006, random_state=201801, max_iter=1)
        model.fit(vectorized_data, target_class)
        success_flag = 'yes'
        status_desc = 'Model Training Successfully Completed'
        return(model,success_flag,status_desc)
    except Exception as error_desc: 
        status_desc = error_desc
        success_flag = 'no'
        model = ''
    return(model,success_flag,status_desc)

# PREDICTION

#'#****************************************************************************************************************************************************
''# Description  					: Code to perform prediction on new data
''# Steps Followed					: Includes the prediction execution & new predicted column creation
''# Input Parameters      			: Model_file, Training_Data, Prediction_Data
''# Output Parameters   			: Predicted File will be returned with new predicted target_class column & confidence score of prediciton per row,
''#									  Function execution success flag,Function execution Status Description
''# Author     						: Eugene Yankovsky
#'#****************************************************************************************************************************************************

#Define Prediction function below:
#-------------------------------------#

def prediction(model, Training_Data, Prediction_Data):
    status_desc = ''
    success_flag = ''
    try:
        p1, p2, p3, p4, p5= pre_processing(Prediction_Data,Training_Data) # Pre-processing function called inside the Prediction Function
        pred_vectorized_data=p3
        Predicted_class = model.predict(pred_vectorized_data)
        Prediction_Data["RECOMMENDATION"]=pd.Series(Predicted_class).values
        codestring = '''01063200 02031900 02032900 02101900 02109900 03011190 03011900 03021300 03028990 03038955 03045900 03048100 03048940 03053210 03071900 04012010 04031000 04039000 04061010 04061090 04063000 04064000 04069010 04069020 04069030 04069090 06029089 06031200 07019000 07051900 07095100 07095900 07096000 07099990 07104000 07109000 07112010 07119000 07122000 07123900 07129010 07129090 07134090 08011110 08021100 08022100 08023100 08023200 08026200 08052000 08062000 08091000 08093010 08093020 08104000 08107000 08109000 08132010 08132020 09021000 09022000 09024000 09041200 09042100 09042200 09096110 09109900 10063019 10063021 10063029 10085090 11029000 11031100 11041900 11052000 11081300 12019000 12040090 12074090 12079990 12119010 12119090 13019090 15042000 15079019 15099010 15099090 15131900 15159090 15179090 16023210 16023220 16024900 17019900 17021100 17049010 17049020 17049090 18062000 18063110 18063120 18063210 18069000 19019090 19023000 19041000 19042000 19049000 19052090 19053100 19054000 19059010 19059020 19059090 20019000 20021000 20055100 20056000 20059900 20079100 20079910 20079990 20086010 20091200 20091900 20096900 20098990 20099000 21011190 21011200 21012010 21031090 21032010 21032090 21039021 21039091 21041011 21041021 21050010 21069010 21069030 21069050 21069090 22041010 22042100 22042911 22071090 22083020 23099010 25010090 25041000 25051000 25081000 25171000 25262000 27101229 27101992 27101999 27102000 27121000 28011000 28042910 28042990 28043000 28051100 28112990 28121019 28170010 28182010 28201000 28211011 28259090 28261990 28309011 28309019 28334020 28342990 28352200 28352400 28366010 28371100 28413000 28429000 28432990 28439090 28461090 28470000 29011000 29024100 29039915 29042090 29051410 29051922 29053100 29054500 29061100 29061300 29061990 29062910 29071100 29071200 29071590 29071910 29091990 29093012 29093019 29121200 29141200 29141300 29141921 29144099 29146990 29152990 29157019 29159032 29159042 29163920 29163990 29171922 29182300 29183010 29189940 29213011 29214219 29214290 29214500 29215990 29221931 29225031 29225099 29232000 29241922 29241939 29242949 29252990 29269012 29280020 29309019 29321910 29329999 29331919 29332919 29332999 29333110 29333200 29333929 29333939 29333946 29333999 29339913 29339932 29339949 29339999 29343090 29349939 29349949 29350029 29350094 29350099 29362190 29362790 29362940 29372140 29372290 29375000 29395990 29399911 29400019 30019090 30023090 30029099 30041011 30042059 30042069 30043210 30043937 30044090 30049024 30049039 30049042 30049049 30049059 30049064 30049069 30049078 30049079 30049099 30051090 30066000 32030019 32030029 32041400 32041913 32041919 32041990 32073000 32081030 32082020 32089010 32089029 32089031 32091010 32099019 32100010 32129090 32139000 32151100 32151900 33021000 33029090 33030020 33042010 33042090 33049100 33049910 33049990 33062000 33069000 33071000 33072090 33073000 34011900 34013000 34029039 34029090 34031900 34042020 34053000 34059000 34060000 34070010 35030019 35052000 35061010 35061090 35069110 35069120 35069900 37079029 37079090 38012090 38021000 38070000 38089429 38101020 38109000 38160090 38190000 38220090 38231200 38237010 38249041 38249053 38249059 38249079 39013090 39021010 39041090 39089090 39095019 39100090 39162000 39169010 39169090 39172100 39172200 39172300 39173210 39173229 39173240 39173300 39173900 39174090 39189000 39191000 39191010 39191020 39199020 39204900 39206900 39207990 39209200 39209990 39222000 39229000 39231010 39232190 39232910 39232990 39235000 39249000 39251000 39253000 39259090 39261000 39263000 39264000 39269021 39269061 39269069 39269090 40012990 40023100 40029920 40059990 40082900 40091100 40091210 40091290 40092110 40092190 40092290 40093100 40093210 40101900 40103200 40103400 40103500 40103900 40111000 40119490 40131090 40149010 40151900 40161010 40169100 40169300 40169590 40169990 41151000 42010010 42010090 42021210 42021900 42022220 42022900 42023100 42023200 42023900 42029200 42029900 44079990 44151000 44170090 44189000 44190000 44219000 45039000 46021200 46021900 48054090 48070000 48081000 48109990 48114190 48114990 48120000 48171000 48189090 48192000 48193000 48194000 48195000 48203000 48209000 48219000 48232010 48232099 48236900 48237000 48239091 49011000 49019100 49030000 49051000 49089000 49100000 49111090 49119900 54026900 56022100 56022900 56031390 56031490 56039410 56074900 56079090 56089000 57019000 57033000 57039000 57049000 57050000 58063900 59022000 59039000 59050000 59069900 59090000 59119000 61032300 61033300 61034200 61045900 61051000 61061000 61082100 61091000 61099000 61113000 61119090 61123100 61151021 61152100 61152990 61161000 61169300 61169900 61178090 62019300 62034200 62034300 62034900 62043100 62045900 62052000 62053000 62063000 62064000 62093000 62101000 62111200 62114200 62114300 62122000 62152000 62160000 63022200 63023200 63025300 63026000 63029990 63031200 63049100 63052000 63053390 63053900 63059000 63061200 63062200 63062990 63069000 63071000 63079010 64052000 64059000 65050022 65050031 65061000 65070000 66039000 67029000 67041900 67042000 67049000 68029100 68029990 68030000 68042119 68042290 68043000 68051000 68052000 68053020 68053090 68069090 68118100 68118200 68118900 68129990 68138110 68159990 69039092 69109000 69111090 69120000 69139000 69141000 70031900 70049000 70080000 70099100 70099200 70109021 70119000 70132800 70133300 70133700 70134100 70169000 70179000 70193900 70195100 70199090 71012200 71023900 71051000 71069210 71069220 71131100 71131900 71132000 71161000 71179000 72051000 72082690 72083990 72085100 72085200 72089000 72091600 72091700 72092600 72103010 72109000 72111900 72112920 72122010 72141090 72142000 72149100 72149990 72162100 72163100 72163200 72163300 72166110 72166190 72169100 72171090 72173090 72189900 72221910 72222000 72230000 72254010 72259990 72285000 73012000 73021090 73029000 73030000 73043910 73044900 73049090 73053100 73053900 73063000 73065000 73066100 73069090 73071100 73071910 73071920 73071990 73072100 73072200 73072300 73072900 73079100 73079300 73083000 73084000 73089010 73090010 73090090 73101090 73102990 73110000 73121010 73121090 73129000 73130000 73143100 73144900 73151100 73151290 73151900 73158100 73158200 73159000 73170020 73170090 73181200 73181300 73181900 73182200 73182400 73182900 73199000 73201000 73202010 73202090 73209000 73211900 73219000 73229090 73231000 73239300 73239400 73239900 73241000 73249000 73251000 73259910 73259990 73261900 73262000 73269010 73269090 74032200 74032900 74050000 74071010 74072910 74082919 74091900 74093900 74111090 74122000 74152100 74153300 74153900 74182000 74199100 74199990 75022000 75072000 76012000 76071110 76071190 76081000 76090000 76101000 76109000 76121000 76129012 76129090 76169900 79070090 81019600 81019990 81099000 81122900 81130090 82013000 82019000 82021000 82023900 82024000 82029100 82029990 82031010 82031090 82042000 82051000 82052000 82054000 82055100 82055900 82059000 82060000 82071900 82072000 82074010 82074020 82075011 82075019 82077010 82077090 82078000 82079000 82083000 82084000 82090011 82090019 82119100 82119290 82119390 82121020 82141000 82152000 82159910 82159990 83011000 83013000 83014000 83015000 83016000 83021000 83022000 83023000 83024100 83024900 83026000 83030000 83040000 83052000 83059000 83061000 83063000 83071090 83082000 83089010 83091000 83099000 83100000 83112000 83113000 84039000 84059000 84069019 84069090 84073200 84073490 84082020 84082030 84099112 84099113 84099114 84099115 84099130 84099190 84099912 84099915 84099921 84099959 84099979 84099999 84101100 84109000 84122110 84122900 84123190 84123900 84128000 84129020 84129080 84129090 84131100 84131900 84133010 84133020 84133030 84133090 84135090 84136011 84136019 84136090 84137010 84137090 84138100 84139190 84139200 84141000 84143099 84144090 84145190 84145990 84148019 84148031 84148039 84148090 84149010 84149020 84149032 84149033 84149034 84149039 84152010 84152090 84159010 84159020 84159090 84162090 84169000 84172000 84182100 84184000 84185010 84186999 84189900 84191990 84193900 84195029 84195090 84198190 84198920 84198940 84198991 84199020 84199090 84209100 84209900 84211990 84212100 84212200 84212300 84212930 84212990 84213100 84213910 84213930 84219910 84219999 84221900 84222000 84223010 84224090 84229010 84231000 84238190 84238200 84238900 84242000 84243010 84243090 84248111 84248190 84248910 84249090 84251100 84251990 84253190 84253910 84253990 84254100 84254200 84254990 84269900 84271019 84282090 84283200 84283300 84283910 84283990 84306990 84311010 84311090 84312011 84312019 84313110 84313190 84313900 84314100 84314390 84314923 84314929 84339010 84362900 84368000 84386000 84399100 84399990 84424010 84424090 84433191 84433223 84433229 84433236 84433259 84433990 84439919 84439929 84439933 84439949 84439960 84439970 84439980 84483100 84483219 84483290 84483390 84483919 84483923 84485910 84485929 84502090 84519090 84522924 84529020 84529089 84571000 84592900 84596900 84609090 84619090 84622100 84622900 84633000 84639090 84642090 84659190 84659211 84659310 84659400 84661000 84662090 84663000 84669200 84669320 84669340 84669350 84669360 84669410 84669490 84671190 84672200 84672992 84672999 84678100 84678900 84679200 84679900 84681000 84682000 84689010 84689090 84702900 84703000 84713012 84714900 84715040 84715090 84716052 84716053 84716090 84717011 84717019 84719011 84719014 84719019 84719090 84729030 84733042 84733049 84733099 84735010 84735090 84741000 84742090 84743900 84748090 84749000 84759000 84769000 84778090 84779000 84795000 84798210 84798911 84798912 84798931 84798992 84798999 84799010 84799090 84804100 84806000 84807100 84811000 84812019 84812090 84813000 84814000 84818019 84818029 84818031 84818039 84818093 84818095 84818096 84818097 84818099 84819010 84819090 84821090 84822010 84823000 84825090 84828000 84829130 84829190 84829910 84831019 84831020 84831040 84831050 84831090 84833010 84833021 84833090 84834010 84834090 84835010 84836019 84836090 84839000 84842000 84849000 84869000 84871000 85011019 85011029 85011030 85012000 85013411 85014011 85014021 85014029 85015110 85015190 85015210 85023900 85024010 85030010 85041000 85043119 85043300 85043400 85044010 85044021 85044029 85044030 85044040 85045000 85049030 85051910 85051990 85052090 85059080 85059090 85061010 85061020 85061030 85065010 85065090 85069000 85071090 85072090 85073011 85074000 85079020 85086000 85087000 85098090 85099000 85109020 85111000 85113010 85114000 85115010 85118020 85118090 85119000 85121000 85122019 85122021 85122023 85124010 85129000 85131010 85131090 85142011 85143090 85151900 85152100 85152900 85153110 85153900 85158090 85162900 85167100 85167920 85167990 85168090 85171211 85171290 85171891 85171899 85176120 85176149 85176229 85176239 85176251 85176255 85176259 85176262 85176279 85176294 85176299 85176900 85177029 85177091 85182100 85183000 85189010 85189090 85198110 85198120 85198900 85232120 85232911 85232919 85234190 85234910 85234990 85235910 85255019 85256010 85258012 85258019 85258029 85269100 85271910 85272100 85272110 85279910 85284120 85284929 85285920 85286100 85286910 85287200 85291019 85291090 85299011 85299012 85309000 85311090 85312000 85318000 85319000 85322990 85332900 85333910 85333990 85334019 85334091 85340019 85340039 85351000 85352100 85352900 85353029 85354010 85354090 85359000 85363000 85364100 85364900 85365010 85365030 85365090 85366100 85366910 85366990 85367000 85369010 85369020 85369030 85369040 85369090 85371011 85371019 85371020 85371030 85371090 85372090 85381000 85389010 85389090 85392110 85392190 85392200 85392910 85392990 85393200 85393900 85399010 85408990 85412199 85414011 85414019 85414026 85415020 85419090 85423110 85423291 85423999 85429090 85432000 85437035 85437036 85437039 85439010 85439090 85441990 85444200 85444900 85447010 85451990 85459030 85459090 85469000 85472010 85472090 85479000 85489090 86071990 86072100 86072900 86079100 86079900 86080090 87019090 87032310 87032410 87043190 87071000 87079090 87082100 87082913 87082914 87082919 87082991 87082992 87082993 87082994 87082999 87083019 87083090 87084011 87084080 87084090 87085012 87085019 87085091 87085099 87087090 87089100 87089200 87089412 87089481 87089482 87089483 87089490 87089510 87089529 87089910 87089990 87099000 87141000 87149100 87149490 87149910 87164000 87168000 87169090 88032000 88039000 89079000 90011019 90011020 90021110 90021120 90029000 90058000 90109010 90109090 90119010 90119090 90129010 90131010 90138090 90142090 90151000 90153000 90158090 90159090 90172000 90173010 90173090 90178010 90181100 90181980 90183190 90183910 90189096 90200010 90200090 90211010 90229019 90230000 90241010 90241090 90248019 90248090 90251110 90251990 90258000 90259010 90259090 90261019 90261021 90261029 90262090 90268000 90269010 90271000 90272011 90273020 90275030 90275090 90278020 90279010 90279091 90279099 90282010 90283031 90283090 90289010 90289090 90291010 90291090 90292010 90299010 90299090 90301010 90302010 90303200 90303319 90303321 90303390 90303910 90308290 90308490 90308920 90308990 90309010 90311000 90312090 90314990 90318011 90318012 90318030 90318050 90318091 90318099 90319010 90319090 90321010 90328100 90328919 90328922 90328923 90328924 90328925 90328929 90328981 90328983 90328984 90328989 90328990 90329099 91029100 91040000 91052100 91052900 91059100 91070090 91139000 91149050 91149060 92099200 92099400 92099900 94012000 94015100 94017100 94017900 94018000 94031000 94032000 94034000 94035000 94037000 94038100 94039010 94039090 94042100 94049000 94051093 94051099 94054010 94054090 94056000 94059900 94060099 95030010 95030021 95030022 95030039 95030070 95030080 95030099 95044000 95049090 95064000 95066200 95069900 95071000 95079000 95089090 96019000 96020090 96033000 96034010 96034090 96035000 96039000 96040000 96062100 96081000 96082000 96084000 96086000 96092000 96099000 96100000 96110000 96121090 96138000 96140000 96162000 96170010 96180000 97030000'''
        low_precision_codelist = codestring.split()
        Prediction_Data["RECOMMENDATION"] = Prediction_Data["RECOMMENDATION"].apply(lambda x: x if x not in low_precision_codelist else 'Manual Classification Needed')
        success_flag = 'yes'
        status_desc = 'Prediction Successfully Completed'
    except Exception as error_desc:
        status_desc =  error_desc
        success_flag = 'no'
    return(Prediction_Data,success_flag,status_desc)




#-----------------------------------------------------------------------------------------------------------------------------------------------------------------#


